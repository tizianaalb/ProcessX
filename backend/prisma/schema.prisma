// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organizations (Multi-tenancy)
model Organization {
  id              String    @id @default(uuid())
  name            String
  logoUrl         String?   @map("logo_url")
  brandingConfig  Json?     @map("branding_config")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  users           User[]
  processes       Process[]
  templates       ProcessTemplate[]
  apiConfigurations APIConfiguration[]

  @@map("organizations")
}

// Users
model User {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  email           String    @unique
  passwordHash    String    @map("password_hash")
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  role            String    @default("editor") // admin, editor, viewer
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdProcesses      Process[] @relation("ProcessCreator")
  painPointsIdentified  PainPoint[] @relation("PainPointIdentifier")
  targetProcesses       TargetProcess[] @relation("TargetProcessCreator")
  exports              Export[]
  auditLogs            AuditLog[]
  initiatedAnalyses    AIAnalysis[]
  approvedRecommendations ProcessRecommendation[] @relation("ApprovedRecommendations")
  backups              Backup[]
  notifications        Notification[]
  reviewsRequested     ProcessReview[] @relation("ReviewRequester")
  reviewsAssigned      ProcessReview[] @relation("ProcessReviewer")

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

// Processes
model Process {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  createdById     String    @map("created_by_id")
  name            String
  description     String?
  type            String    @default("AS_IS") // AS_IS, TO_BE
  category        String?   // claims, underwriting, policy, etc.
  status          String    @default("DRAFT") // DRAFT, ACTIVE, ARCHIVED
  version         Int       @default(1)
  parentProcessId String?   @map("parent_process_id") // for versioning
  metadata        Json?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User @relation("ProcessCreator", fields: [createdById], references: [id])
  parentProcess   Process? @relation("ProcessVersions", fields: [parentProcessId], references: [id])

  childVersions   Process[] @relation("ProcessVersions")
  steps           ProcessStep[]
  connections     ProcessConnection[]
  painPoints      PainPoint[]
  recommendations Recommendation[]
  targetProcesses TargetProcess[]
  exports         Export[]
  aiAnalyses      AIAnalysis[]
  processRecommendations ProcessRecommendation[]
  healthMetrics   ProcessHealthMetric[]
  reviews         ProcessReview[]

  @@index([organizationId])
  @@index([createdById])
  @@index([category])
  @@index([status])
  @@map("processes")
}

// Process Steps
model ProcessStep {
  id                    String    @id @default(uuid())
  processId             String    @map("process_id")
  order                 Int       // Step order in process
  name                  String
  description           String?
  type                  String    @default("TASK") // START, TASK, DECISION, END
  duration              Int?      // in minutes
  responsibleRole       String?   @map("responsible_role")
  department            String?
  requiredSystems       String[]  @default([]) @map("required_systems")
  inputs                String[]  @default([])
  outputs               String[]  @default([])
  complianceRequirements String[] @default([]) @map("compliance_requirements")
  positionX             Float     @map("position_x")
  positionY             Float     @map("position_y")
  metadata              Json?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  process               Process @relation(fields: [processId], references: [id], onDelete: Cascade)

  sourceConnections     ProcessConnection[] @relation("SourceStep")
  targetConnections     ProcessConnection[] @relation("TargetStep")
  painPoints            PainPoint[]

  @@index([processId])
  @@map("process_steps")
}

// Process Connections (Edges)
model ProcessConnection {
  id            String    @id @default(uuid())
  processId     String    @map("process_id")
  sourceStepId  String    @map("source_step_id")
  targetStepId  String    @map("target_step_id")
  label         String?   // Label for the connection
  type          String    @default("DEFAULT") // DEFAULT, CONDITIONAL
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at")

  process       Process @relation(fields: [processId], references: [id], onDelete: Cascade)
  sourceStep    ProcessStep @relation("SourceStep", fields: [sourceStepId], references: [id], onDelete: Cascade)
  targetStep    ProcessStep @relation("TargetStep", fields: [targetStepId], references: [id], onDelete: Cascade)

  @@index([processId])
  @@map("process_connections")
}

// Pain Points
model PainPoint {
  id                String    @id @default(uuid())
  processId         String    @map("process_id")
  processStepId     String?   @map("process_step_id")
  identifiedById    String    @map("identified_by_id")
  category          String    // BOTTLENECK, REWORK, WASTE, MANUAL_PROCESS, COMPLIANCE_RISK, SYSTEM_LIMITATION, COMMUNICATION_GAP
  severity          String    // LOW, MEDIUM, HIGH, CRITICAL
  title             String
  description       String
  impact            String?   // Description of business impact
  estimatedCost     Int?      @map("estimated_cost") // Annual cost in currency
  estimatedTime     Int?      @map("estimated_time") // Time wasted per occurrence in minutes
  frequency         String?   // DAILY, WEEKLY, MONTHLY, QUARTERLY, ANNUALLY
  isAiDetected      Boolean   @default(false) @map("is_ai_detected")
  status            String    @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, DISMISSED
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  process           Process @relation(fields: [processId], references: [id], onDelete: Cascade)
  processStep       ProcessStep? @relation(fields: [processStepId], references: [id], onDelete: Cascade)
  identifiedBy      User @relation("PainPointIdentifier", fields: [identifiedById], references: [id])

  recommendations   Recommendation[]

  @@index([processId])
  @@index([processStepId])
  @@map("pain_points")
}

// Recommendations
model Recommendation {
  id                  String    @id @default(uuid())
  processId           String    @map("process_id")
  painPointId         String?   @map("pain_point_id")
  recommendationType  String    @map("recommendation_type") // automation, elimination, reorder, etc.
  title               String
  description         String?
  implementationSteps String[]  @map("implementation_steps")
  estimatedEffort     String?   @map("estimated_effort") // low, medium, high
  estimatedImpact     Json?     @map("estimated_impact") // time_saved, cost_reduction, etc.
  priorityScore       Int?      @map("priority_score")
  status              String    @default("proposed") // proposed, approved, implemented, rejected
  generatedBy         String    @map("generated_by") // ai, manual
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  process             Process @relation(fields: [processId], references: [id], onDelete: Cascade)
  painPoint           PainPoint? @relation(fields: [painPointId], references: [id], onDelete: SetNull)

  @@index([processId])
  @@map("recommendations")
}

// Target Processes (Optimized versions)
model TargetProcess {
  id                    String    @id @default(uuid())
  sourceProcessId       String    @map("source_process_id")
  name                  String
  description           String?
  businessRequirements  Json?     @map("business_requirements")
  implementationRoadmap Json?     @map("implementation_roadmap")
  impactAnalysis        Json?     @map("impact_analysis")
  createdById           String    @map("created_by_id")
  status                String    @default("proposed") // proposed, approved, in_progress, implemented
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  sourceProcess         Process @relation(fields: [sourceProcessId], references: [id], onDelete: Cascade)
  createdBy             User @relation("TargetProcessCreator", fields: [createdById], references: [id])

  @@index([sourceProcessId])
  @@map("target_processes")
}

// Process Templates
model ProcessTemplate {
  id              String    @id @default(uuid())
  organizationId  String?   @map("organization_id") // null = public template
  name            String
  description     String?
  category        String?
  subcategory     String?
  industrySector  String    @default("insurance") @map("industry_sector")
  templateData    Json      @map("template_data") // full process structure
  previewImageUrl String?   @map("preview_image_url")
  isPublic        Boolean   @default(true) @map("is_public")
  usageCount      Int       @default(0) @map("usage_count")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([isPublic])
  @@map("process_templates")
}

// Exports
model Export {
  id          String    @id @default(uuid())
  processId   String    @map("process_id")
  userId      String    @map("user_id")
  exportType  String    @map("export_type") // pptx, pdf, xlsx, docx, png, svg
  fileUrl     String?   @map("file_url")
  fileSizeBytes BigInt? @map("file_size_bytes")
  exportConfig Json?    @map("export_config")
  status      String    @default("pending") // pending, completed, failed
  errorMessage String?  @map("error_message")
  createdAt   DateTime  @default(now()) @map("created_at")

  process     Process @relation(fields: [processId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id])

  @@index([processId])
  @@index([userId])
  @@map("exports")
}

// API Configuration
model APIConfiguration {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  provider        String    // ANTHROPIC, GOOGLE_GEMINI, OPENAI, AZURE_OPENAI
  apiKey          String    @map("api_key")
  modelId         String?   @map("model_id") // e.g., claude-3-5-sonnet-20241022, gemini-pro
  isActive        Boolean   @default(true) @map("is_active")
  isDefault       Boolean   @default(false) @map("is_default") // default provider for AI operations
  config          Json?     // Additional configuration (endpoints, parameters, etc.)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([provider])
  @@unique([organizationId, provider])
  @@map("api_configurations")
}

// AI Analysis Results
model AIAnalysis {
  id                  String    @id @default(uuid())
  processId           String    @map("process_id")
  analysisType        String    // FULL, PAIN_POINTS, RECOMMENDATIONS, TO_BE
  status              String    // PENDING, IN_PROGRESS, COMPLETED, FAILED
  progressStep        String?   @map("progress_step") // Current step: gathering, understanding, pain_points, recommendations, to_be

  // Results
  understanding       Json?     // Process understanding
  detectedPainPoints  Json?     // Array of detected pain points
  recommendations     Json?     // Array of recommendations
  generatedProcess    Json?     // TO-BE process structure

  // Metadata
  aiProvider          String    // Which AI was used
  modelId             String?   // Model identifier
  tokensUsed          Int?      @map("tokens_used")
  cost                Decimal?  @db.Decimal(10, 4)
  errorMessage        String?   @map("error_message")

  initiatedById       String    @map("initiated_by_id")
  completedAt         DateTime? @map("completed_at")
  createdAt           DateTime  @default(now()) @map("created_at")

  process             Process   @relation(fields: [processId], references: [id], onDelete: Cascade)
  initiatedBy         User      @relation(fields: [initiatedById], references: [id])
  processRecommendations ProcessRecommendation[]

  @@index([processId])
  @@index([status])
  @@map("ai_analyses")
}

// Process Improvement Recommendations
model ProcessRecommendation {
  id                  String    @id @default(uuid())
  processId           String    @map("process_id")
  analysisId          String?   @map("analysis_id")

  category            String    // QUICK_WIN, STRATEGIC, AUTOMATION, INTEGRATION, REDESIGN
  priority            String    // HIGH, MEDIUM, LOW
  title               String
  description         String    @db.Text
  expectedBenefits    Json      // Array of benefits

  implementation      Json      // {effort, timeline, steps}
  metrics             Json      // {timeSaving, costSaving, riskReduction}

  status              String    @default("PENDING") // PENDING, APPROVED, REJECTED, IMPLEMENTED
  approvedById        String?   @map("approved_by_id")
  approvedAt          DateTime? @map("approved_at")
  implementedAt       DateTime? @map("implemented_at")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  process             Process   @relation(fields: [processId], references: [id], onDelete: Cascade)
  analysis            AIAnalysis? @relation(fields: [analysisId], references: [id])
  approvedBy          User?     @relation("ApprovedRecommendations", fields: [approvedById], references: [id])

  @@index([processId])
  @@index([status])
  @@index([priority])
  @@map("process_recommendations")
}

// Audit Logs
model AuditLog {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  entityType  String    @map("entity_type") // process, step, pain_point, etc.
  entityId    String    @map("entity_id")
  action      String    // create, update, delete, export
  changes     Json?
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// Database Backups
model Backup {
  id          String    @id @default(uuid())
  filename    String    @unique
  filepath    String    // Path to backup file on server
  fileSize    BigInt    @map("file_size") // File size in bytes
  metadata    Json      // Backup metadata (version, timestamp, stats, etc.)
  createdBy   String    @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User @relation(fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([createdAt])
  @@map("backups")
}

// Process Health Metrics - Track process health scores over time
model ProcessHealthMetric {
  id          String    @id @default(uuid())
  processId   String    @map("process_id")
  score       Int       // 0-100 overall health score
  complexity  Int       // Complexity score based on nodes/connections
  bottlenecks Int       // Number of identified bottlenecks
  cycleTime   Float?    @map("cycle_time") // Estimated cycle time in minutes
  details     Json?     // Detailed breakdown of health factors
  createdAt   DateTime  @default(now()) @map("created_at")

  process     Process   @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@index([processId])
  @@index([createdAt])
  @@map("process_health_metrics")
}

// Notifications
model Notification {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  type        String    // mention, review_request, approval, comment, system
  title       String
  content     String    @db.Text
  link        String?   // Link to related resource
  read        Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// Process Reviews - Approval workflow for processes
model ProcessReview {
  id          String    @id @default(uuid())
  processId   String    @map("process_id")
  requesterId String    @map("requester_id")
  reviewerId  String?   @map("reviewer_id")
  status      String    @default("pending") // pending, approved, rejected, changes_requested
  comments    String?   @db.Text
  decision    String?   // Final decision notes
  requestedAt DateTime  @default(now()) @map("requested_at")
  reviewedAt  DateTime? @map("reviewed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  process     Process   @relation(fields: [processId], references: [id], onDelete: Cascade)
  requester   User      @relation("ReviewRequester", fields: [requesterId], references: [id])
  reviewer    User?     @relation("ProcessReviewer", fields: [reviewerId], references: [id])

  @@index([processId])
  @@index([reviewerId])
  @@index([status])
  @@map("process_reviews")
}
